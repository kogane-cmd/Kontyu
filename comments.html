<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</title>
  <link rel="stylesheet" href="style.css">
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    .search-box { margin-bottom: 10px; }
    .search-box input { margin-right: 5px; }
    button.block-btn { background: red; color: white; border: none; padding: 3px 6px; cursor: pointer; }
    button.unblock-btn { background: green; color: white; border: none; padding: 3px 6px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <a href="index.html"><img src="logo.png" alt="ç©ºæƒ³æ˜†è™«å›³é‘‘" style="height:100px;"></a>
    </div>
    <nav>
      <a href="index.html">ãƒˆãƒƒãƒ—</a>
      <a href="new.html">æ–°è¦ä½œæˆ</a>
      <a href="list.html">ãƒªã‚¹ãƒˆ</a>
    </nav>
  </header>

  <main>
    <h2>å…¨ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>

    <div class="search-box">
      <label>èª¬æ˜: <input type="text" id="searchDescription"></label>
      <label>No.: <input type="text" id="searchNo" placeholder="ä¾‹: 5~10"></label>
      <label>åç§°: <input type="text" id="searchName"></label>
      <label>ä½œæˆè€…: <input type="text" id="searchAuthor"></label>
      <label>ID: <input type="text" id="searchId"></label>
      <label>UserID: <input type="text" id="searchUserId"></label>
    </div>

    <label for="commentSort">ä¸¦ã³æ›¿ãˆï¼š</label>
    <select id="commentSort">
      <option value="newest">æ–°ã—ã„é †</option>
      <option value="oldest">å¤ã„é †</option>
      <option value="likes">é«˜è©•ä¾¡é †</option>
    </select>

    <table id="allComments"></table>
    <button id="moreBtn" style="margin-top:10px; display:none;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
  </main>

  <script>
    // ===== ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä»®ã®å‡¦ç†ï¼‰ =====
    let currentUserId = localStorage.getItem("currentUserId") || "guest";

    // ===== è’ã‚‰ã—ç®¡ç† =====
    let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers") || "[]");

    function blockUser(userId) {
      if (!blockedUsers.includes(userId)) {
        blockedUsers.push(userId);
        localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));
        alert(userId + " ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ");
        renderComments(true);
      }
    }

    function unblockUser(userId) {
      blockedUsers = blockedUsers.filter(u => u !== userId);
      localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));
      alert(userId + " ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
      renderComments(true);
    }

    function isBlocked(userId) {
      if (userId === "kanrinin") return false; // ç®¡ç†äººã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„
      return blockedUsers.includes(userId);
    }

    // ===== ã‚³ãƒ¡ãƒ³ãƒˆåé›† =====
    let insects = JSON.parse(localStorage.getItem("insects") || "[]");
    let comments = [];

    insects.forEach(insect => {
      let commentCounter = 1; // ä½œå“ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆ
      (insect.comments || []).forEach(c => {
        collectComments(c, insect, () => commentCounter++);
      });
    });

    function collectComments(c, insect, counterFunc) {
      comments.push({
        ...c,
        insectName: insect.name,
        insectId: insect.id,
        insectDescription: insect.description,
        insectAuthor: insect.user,
        displayNo: counterFunc()
      });
      (c.replies || []).forEach(r => collectComments(r, insect, counterFunc));
    }

    // ===== æ—¥ä»˜é–¢æ•° =====
    function getDate(c) {
      return new Date(c.date || c.time || c.timestamp || 0);
    }

    // ===== ä¸¦ã³æ›¿ãˆ =====
    function sortComments(type, list) {
      let sorted = [...list];
      switch (type) {
        case "newest": sorted.sort((a,b) => getDate(b) - getDate(a)); break;
        case "oldest": sorted.sort((a,b) => getDate(a) - getDate(b)); break;
        case "likes": sorted.sort((a,b) => (b.likes || 0) - (a.likes || 0)); break;
      }
      return sorted;
    }

    // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° =====
    function filterComments(list) {
      let desc = document.getElementById("searchDescription").value.toLowerCase();
      let no = document.getElementById("searchNo").value;
      let name = document.getElementById("searchName").value.toLowerCase();
      let author = document.getElementById("searchAuthor").value.toLowerCase();
      let id = document.getElementById("searchId").value;
      let userId = document.getElementById("searchUserId").value;

      return list.filter(c => {
        if (desc && !(c.insectDescription || "").toLowerCase().includes(desc)) return false;
        if (name && !(c.insectName || "").toLowerCase().includes(name)) return false;
        if (author && !(c.insectAuthor || "").toLowerCase().includes(author)) return false;
        if (id && String(c.insectId) !== id) return false;
        if (userId && String(c.userId || "") !== userId) return false;

        if (no) {
          let range = no.split("~").map(x => parseInt(x.trim()));
          if (range.length === 2) {
            if (!(c.displayNo >= range[0] && c.displayNo <= range[1])) return false;
          } else if (range.length === 1 && no.trim() !== "") {
            if (c.displayNo !== range[0]) return false;
          }
        }
        return true;
      });
    }

    // ===== ãƒšãƒ¼ã‚¸ãƒ³ã‚° =====
    let perPage = 10;
    let currentPage = 1;
    let sortedGlobal = [];

    function renderComments(reset=true) {
      if (reset) currentPage = 1;
      let sortType = document.getElementById("commentSort").value;

      let filtered = filterComments(comments);
      sortedGlobal = sortComments(sortType, filtered);

      let visible = sortedGlobal.slice(0, currentPage * perPage);

      document.getElementById("allComments").innerHTML =
        "<tr><th>No.</th><th>ä½œå“</th><th>ä½œæˆè€…</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>UserID</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ—¥ä»˜</th><th>ğŸ‘</th><th>æ“ä½œ</th></tr>" +
        visible.map(c => `<tr>
          <td>${c.displayNo}</td>
          <td><a href="detail.html?id=${c.insectId}">${c.insectName}</a></td>
          <td>${c.insectAuthor || ""}</td>
          <td>${c.user || ""}</td>
          <td>${c.userId || ""}</td>
          <td>${c.text || ""}</td>
          <td>${c.date || c.time || c.timestamp || ""}</td>
          <td>${c.likes || 0}</td>
          <td>
            ${(currentUserId === "kanrinin" && c.userId) 
              ? (isBlocked(c.userId)
                  ? `<button class="unblock-btn" onclick="unblockUser('${c.userId}')">è§£é™¤</button>`
                  : `<button class="block-btn" onclick="blockUser('${c.userId}')">ãƒ–ãƒ­ãƒƒã‚¯</button>`)
              : ""}
            ${isBlocked(c.userId) ? "ğŸš«" : ""}
          </td>
        </tr>`).join("");

      document.getElementById("moreBtn").style.display =
        visible.length < sortedGlobal.length ? "block" : "none";
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    document.querySelectorAll(".search-box input").forEach(inp =>
      inp.addEventListener("input", () => renderComments(true))
    );
    document.getElementById("commentSort").addEventListener("change", () => renderComments(true));
    document.getElementById("moreBtn").addEventListener("click", () => {
      currentPage++;
      renderComments(false);
    });

    // åˆæœŸè¡¨ç¤º
    renderComments();
  </script>
</body>
</html>
