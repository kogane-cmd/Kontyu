<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä½œå“è©³ç´°</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="header-left">
      <a href="index.html"><img src="logo.png" alt="ç©ºæƒ³æ˜†è™«å›³é‘‘" style="height:100px;"></a>
    </div>
    <nav>
      <a href="index.html">ãƒˆãƒƒãƒ—</a>
      <a href="new.html">æ–°è¦ä½œæˆ</a>
      <a href="list.html">ãƒªã‚¹ãƒˆ</a>
      <a href="comments.html">ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</a>
    </nav>
  </header>

  <main>
    <h2 id="insectName"></h2>
    <p id="insectDescription"></p>
    <p>ä½œæˆè€…: <span id="insectAuthor"></span></p>
    <p>ä½œè€…ID: <span id="insectUserId"></span></p>
    <p>ã‚¢ã‚¯ã‚»ã‚¹æ•°: <span id="insectViews"></span></p>
    <p><img id="insectImage" alt="æ˜†è™«ç”»åƒ" style="max-width:400px;"></p>

    <h3>ä½œå“ã¸ã®é«˜è©•ä¾¡</h3>
    <p>
      ğŸ‘ <span id="insectLikes">0</span>
      <button id="likeBtn">ã“ã®ä½œå“ã‚’é«˜è©•ä¾¡ã™ã‚‹</button>
    </p>

    <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
    <ul id="commentsList"></ul>

    <h3>ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹</h3>
    <p>åå‰: <input type="text" id="commentUser" placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆçœç•¥å¯ï¼‰"></p>
    <textarea id="commentText" rows="3" cols="50" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br>
    <button id="postComment">æŠ•ç¨¿</button>
  </main>

  <script>
    // ===== ä»®ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç®¡ç†äººIDã‚’ã‚»ãƒƒãƒˆï¼‰ =====
    localStorage.setItem("currentUserId", "kanrinin");

    // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± =====
    let currentUserId = localStorage.getItem("currentUserId") || "guest";

    // ===== è’ã‚‰ã—ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ =====
    let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers") || "[]");
    function isBlocked(userId) {
      if (userId === "kanrinin") return false; // ç®¡ç†äººã¯é™¤å¤–
      return blockedUsers.includes(userId);
    }

    // ===== URLã‹ã‚‰ä½œå“IDã‚’å–å¾— =====
    const params = new URLSearchParams(location.search);
    const insectId = params.get("id");

    let insects = JSON.parse(localStorage.getItem("insects") || "[]");
    let insect = insects.find(i => String(i.id) === insectId);

    if (!insect) {
      document.body.innerHTML = "<p>ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
    } else {
      // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åˆæœŸåŒ–
      if (insect.likes === undefined) insect.likes = 0;
      if (!insect.likedUsers) insect.likedUsers = [];

      document.getElementById("insectName").textContent = insect.name;
      document.getElementById("insectDescription").textContent = insect.description;
      document.getElementById("insectAuthor").textContent = insect.user;
      document.getElementById("insectUserId").textContent = insect.userId || "ä¸æ˜";
      document.getElementById("insectViews").textContent = insect.views || 0;
      document.getElementById("insectLikes").textContent = insect.likes;

      if (insect.image) {
        document.getElementById("insectImage").src = insect.image;
      } else {
        document.getElementById("insectImage").style.display = "none";
      }

      updateLikeButton();
      renderComments();
    }

    // ===== ä½œå“é«˜è©•ä¾¡å‡¦ç†ï¼ˆãƒˆã‚°ãƒ«å¼ï¼‰ =====
    function updateLikeButton() {
      let btn = document.getElementById("likeBtn");
      if (insect.likedUsers.includes(currentUserId)) {
        btn.textContent = "é«˜è©•ä¾¡ã‚’å–ã‚Šæ¶ˆã™";
      } else {
        btn.textContent = "ã“ã®ä½œå“ã‚’é«˜è©•ä¾¡ã™ã‚‹";
      }
    }

    document.getElementById("likeBtn").addEventListener("click", () => {
      if (!insect.likedUsers) insect.likedUsers = [];

      if (insect.likedUsers.includes(currentUserId)) {
        // å–ã‚Šæ¶ˆã—
        insect.likes = Math.max(0, insect.likes - 1);
        insect.likedUsers = insect.likedUsers.filter(u => u !== currentUserId);
      } else {
        // é«˜è©•ä¾¡
        insect.likes++;
        insect.likedUsers.push(currentUserId);
      }

      localStorage.setItem("insects", JSON.stringify(insects));
      document.getElementById("insectLikes").textContent = insect.likes;
      updateLikeButton();
    });

    // ===== ã‚³ãƒ¡ãƒ³ãƒˆæç”»ï¼ˆè¿”ä¿¡ï¼‹é«˜è©•ä¾¡ï¼‰ =====
    function renderComments() {
      let ul = document.getElementById("commentsList");
      ul.innerHTML = "";
      (insect.comments || []).forEach(c => {
        ul.appendChild(renderCommentItem(c));
      });
    }

    function renderCommentItem(c) {
      if (c.likes === undefined) c.likes = 0;
      if (!c.likedUsers) c.likedUsers = [];

      let li = document.createElement("li");
      li.innerHTML = `
        <b>${c.user}</b> (${c.userId || "ä¸æ˜"}) : ${c.text}
        <small>[${c.date}] ğŸ‘<span class="likeCount">${c.likes}</span></small>
        <button class="likeBtn">ğŸ‘</button>
        <button class="replyBtn">è¿”ä¿¡</button>
        <div class="replyBox" style="display:none; margin-left:20px;">
          <input type="text" class="replyUser" placeholder="åå‰ï¼ˆçœç•¥å¯ï¼‰"><br>
          <textarea class="replyText" rows="2" cols="40" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea><br>
          <button class="sendReply">é€ä¿¡</button>
        </div>
        <ul class="replies"></ul>
      `;

      // ã‚³ãƒ¡ãƒ³ãƒˆé«˜è©•ä¾¡å‡¦ç†
      li.querySelector(".likeBtn").addEventListener("click", () => {
        if (c.likedUsers.includes(currentUserId)) {
          // å–ã‚Šæ¶ˆã—
          c.likes = Math.max(0, c.likes - 1);
          c.likedUsers = c.likedUsers.filter(u => u !== currentUserId);
        } else {
          // é«˜è©•ä¾¡
          c.likes++;
          c.likedUsers.push(currentUserId);
        }
        localStorage.setItem("insects", JSON.stringify(insects));
        renderComments();
      });

      // è¿”ä¿¡ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºåˆ‡æ›¿
      li.querySelector(".replyBtn").addEventListener("click", () => {
        let box = li.querySelector(".replyBox");
        box.style.display = (box.style.display === "none") ? "block" : "none";
      });

      // è¿”ä¿¡é€ä¿¡
      li.querySelector(".sendReply").addEventListener("click", () => {
        let name = li.querySelector(".replyUser").value.trim() || "åç„¡ã—";
        let text = li.querySelector(".replyText").value.trim();
        if (!text) {
          alert("è¿”ä¿¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }
        let reply = {
          user: name,
          userId: currentUserId,
          text: text,
          date: new Date().toLocaleString(),
          likes: 0,
          likedUsers: [],
          replies: []
        };
        if (!c.replies) c.replies = [];
        c.replies.push(reply);
        localStorage.setItem("insects", JSON.stringify(insects));
        renderComments();
      });

      // å†å¸°çš„ã«è¿”ä¿¡ã‚’æç”»
      let repliesUl = li.querySelector(".replies");
      (c.replies || []).forEach(r => {
        repliesUl.appendChild(renderCommentItem(r));
      });

      return li;
    }

    // ===== ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å‡¦ç† =====
    document.getElementById("postComment").addEventListener("click", () => {
      if (isBlocked(currentUserId)) {
        alert("ã‚ãªãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã›ã‚“ï¼ˆç®¡ç†äººã«ã‚ˆã‚Šåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ï¼‰");
        return;
      }

      let text = document.getElementById("commentText").value.trim();
      let nameInput = document.getElementById("commentUser").value.trim();
      let userName = nameInput || "åç„¡ã—";   // æœªå…¥åŠ›ãªã‚‰åç„¡ã—

      if (!text) {
        alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      let newComment = {
        user: userName,
        userId: currentUserId,
        text: text,
        date: new Date().toLocaleString(),
        likes: 0,
        likedUsers: [],
        replies: []
      };

      if (!insect.comments) insect.comments = [];
      insect.comments.push(newComment);

      // ä¿å­˜
      localStorage.setItem("insects", JSON.stringify(insects));

      // è¡¨ç¤ºæ›´æ–°
      document.getElementById("commentText").value = "";
      document.getElementById("commentUser").value = "";
      renderComments();
    });
  </script>
</body>
</html>
